extends layout

block content

  -
     function parseJwt (token) {
         var base64Url = token.split('.')[1];
         var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
         var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
             return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
         }).join(''));

         return JSON.parse(jsonPayload);
     };

  .content
    h1 Call an API

    if error
        h3(style="color: red; margin-left: 0px;padding-left: 0px !important;") Error
        pre
            code(id="error_details" class="prettyprint" style="word-break: break-all; white-space: normal;") error: #{error} #{response.statusCode} <br> error_description: #{error_description}

    if access_token
      -
        access_token_decoded = parseJwt(access_token);

          const dateTwo = new Date(0);
          dateTwo.setUTCSeconds(access_token_decoded.exp);
          const seconds = ((new Date(dateTwo.valueOf()) - new Date())/ 1000);
          var expiration = "Access Token Expires in " + seconds + " seconds at " + new Date(dateTwo.valueOf());
          if (seconds < 0) {
            expiration = "Access Token has expired at " + new Date(dateTwo.valueOf()) + "";
          }


      p #{expiration}
        table(id="tokens")
            tr
                td
                    a(href="#" alt="copy access_token", id="access_token_button" onclick="copyToClipboard('#access_token')" )
                        img(height="40px",src=`/images/icon-access-token.svg`)
                td
                    pre
                        code(id="access_token" class="prettyprint" style="word-break: break-all; white-space: normal;") #{access_token}
            tr
                td
                td
                    pre
                        code(id="access_token_decoded" class="prettyprint" style="word-break: break-all; white-space: normal;") #{JSON.stringify(access_token_decoded)}

    if data
        p data #{data}

    form(action="/call_api" method="POST")

        p access_token:
          textarea(name="access_token" id="access_token" style="width:100%" value=access_token) #{access_token}
        p read/write:
            select(name="action" id="action" style="width:400px")
                option(value="read") read
                option(value="write") write

        input(type="submit")

    table(style='width:90%;table-layout:fixed', border='0')
          tr
            td

                div(id="request_details")

                    if(error)
                        h3(style="margin-left: 0px;padding-left: 0px !important;") + Error details
                        pre
                            code(id="error_details" class="prettyprint" style="word-break: break-all; white-space: normal;") error: #{error} <br> error_description: #{error_description}

                    if(request)
                        h3(style="margin-left: 0px;padding-left: 0px !important;") + Request details
                        pre
                            code(id="request_url" class="prettyprint" style="word-break: break-all; white-space: normal;") URL: #{request.uri} <br> Method: #{request.method} <br> Body: #{JSON.stringify(request.form)} <br> Headers: #{JSON.stringify(request.headers)}

                    if(response)
                        h3(style="margin-left: 0px;padding-left: 0px !important;") + Response details
                        pre
                            code(id="response_url" class="prettyprint" style="word-break: break-all; white-space: normal;") Body: #{JSON.stringify(response.body)} <br> Status Code : #{response.statusCode} <br> Headers : #{JSON.stringify(response.headers)}
